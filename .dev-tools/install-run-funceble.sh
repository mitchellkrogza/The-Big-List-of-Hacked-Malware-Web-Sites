#!/bin/bash
# ********************
# Run Funceble Testing
# ********************

# Created by: Mitchell Krog (mitchellkrog@gmail.com)
# Copyright: Mitchell Krog - https://github.com/mitchellkrogza
# Repo Url: https://github.com/mitchellkrogza/The-Big-List-of-Hacked-Malware-Web-Sites

# ****************************************************************
# This uses the awesome funceble script created by Nissar Chababy
# Find funceble at: https://github.com/funilrys/funceble
# ****************************************************************

# ******************
# Set our Input File
# ******************
_input=${TRAVIS_BUILD_DIR}/.dev-tools/_strip_domains/domains.txt

# *********************************
# Make scripts executable by Travis
# *********************************

sudo chmod +x ${TRAVIS_BUILD_DIR}/.dev-tools/_funceble/tool
sudo chmod +x ${TRAVIS_BUILD_DIR}/.dev-tools/_funceble/funceble

cd ${TRAVIS_BUILD_DIR}/.dev-tools/PyFunceble/

# ************************
# Settings date variables
# ************************

YEAR=$(date +%Y)
MONTH=$(date +%m)


# *****************************************************
# Exporting all variable that are needed by PyFunceble
# *****************************************************

export TRAVIS_BUILD_DIR=${TRAVIS_BUILD_DIR}
export GH_TOKEN=${GH_TOKEN}
export TRAVIS_REPO_SLUG=${TRAVIS_REPO_SLUG}
export GIT_EMAIL=${GIT_EMAIL}
export GIT_NAME=${GIT_NAME}

# ******************************************************************************
# Updating PyFunceble && Run PyFunceble
# Note: We use the same statement so that if something is broken everything else
#   is not run.
# ******************************************************************************

if [ -f ${TRAVIS_BUILD_DIR}/.dev-tools/PyFunceble/tool.py ]
then
  sudo python3 ${TRAVIS_BUILD_DIR}/.dev-tools/PyFunceble/tool.py --dev -u && \
  sudo python3 ${TRAVIS_BUILD_DIR}/.dev-tools/PyFunceble/PyFunceble.py --travis --cmd-before-end "bash ${TRAVIS_BUILD_DIR}/.dev-tools/modify-readme-file.sh" -a -ex --plain --split --share-logs --autosave-minutes 10 --commit-autosave-message "V1.${YEAR}.${MONTH}.${TRAVIS_BUILD_NUMBER} [PyFunceble]" --commit-results-message "V1.${YEAR}.${MONTH}.${TRAVIS_BUILD_NUMBER}" -f $_input
else
  sudo python3 ${TRAVIS_BUILD_DIR}/.dev-tools/PyFunceble/PyFunceble.py --dev -u && \
  sudo python3 ${TRAVIS_BUILD_DIR}/.dev-tools/PyFunceble/PyFunceble.py --travis --cmd-before-end "bash ${TRAVIS_BUILD_DIR}/.dev-tools/modify-readme-file.sh" -a -ex --plain --split --share-logs --autosave-minutes 10 --commit-autosave-message "V1.${YEAR}.${MONTH}.${TRAVIS_BUILD_NUMBER} [PyFunceble]" --commit-results-message "V1.${YEAR}.${MONTH}.${TRAVIS_BUILD_NUMBER}" -f $_input
fi
exit ${?}
